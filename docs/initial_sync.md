# Initial Sync ä½¿ç”¨ä¸è®¾è®¡è¯´æ˜

## æ¦‚è¿°

`initial_sync.py` æ˜¯ MailAgent çš„åˆå§‹åŒ–åŒæ­¥è„šæœ¬ï¼Œç”¨äºå°† Mail.app ä¸­çš„å†å²é‚®ä»¶åŒæ­¥åˆ° Notionï¼Œå¹¶å»ºç«‹å®Œæ•´çš„é‚®ä»¶çº¿ç¨‹å…³ç³»ï¼ˆParent Itemï¼‰ã€‚

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
1. ä» Mail.app è·å–é‚®ä»¶å…ƒæ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆSyncStoreï¼‰
2. ä¸ Notion æ•°æ®åº“è¿›è¡Œè¯¦ç»†å¯¹æ¯”åˆ†æ
3. æ‰§è¡Œå¢é‡åŒæ­¥å’Œä¿®å¤æ“ä½œ
4. å»ºç«‹å’Œä¿®å¤é‚®ä»¶çº¿ç¨‹çš„ Parent Item å…³è”

## æ¶æ„è®¾è®¡

### æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Initial Sync æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Phase 1: ç¼“å­˜é¢„çƒ­                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚  Mail.app   â”‚â”€â”€â”€â”€â–¶â”‚    SyncStore    â”‚                               â”‚
â”‚  â”‚ (AppleScript)â”‚     â”‚   (SQLite DB)   â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                              â”‚                                          â”‚
â”‚  Phase 2: åˆ†æå¯¹æ¯”           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚              SyncStore vs Notion å¯¹æ¯”                â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚               â”‚
â”‚  â”‚  â”‚ matched â”‚  â”‚ mismatch    â”‚  â”‚ store_only/     â”‚  â”‚               â”‚
â”‚  â”‚  â”‚ (å·²åŒæ­¥) â”‚  â”‚ (å±æ€§/å…³é”®) â”‚  â”‚ notion_only     â”‚  â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                              â”‚                                          â”‚
â”‚  Phase 3: ä¿®å¤æ“ä½œ           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  fix-properties â”‚ fix-critical â”‚ sync-new â”‚ etc.   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                              â”‚                                          â”‚
â”‚  Phase 4: Parent Item æ›´æ–°   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚           update-all-parents                        â”‚               â”‚
â”‚  â”‚  æ–°æ¶æ„ï¼šæœ€æ–°é‚®ä»¶ä¸ºæ¯èŠ‚ç‚¹ï¼Œè®¾ç½® Sub-item è‡ªåŠ¨é‡å»º    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†ç¦»å¼æ‰§è¡Œè®¾è®¡

é‡‡ç”¨ **åˆ†æ-æŠ¥å‘Š-æ‰§è¡Œ** çš„åˆ†ç¦»å¼æ¶æ„ï¼š

```
analyze (ç”Ÿæˆ JSON æŠ¥å‘Š) â”€â”€â–¶ äººå·¥å®¡æŸ¥ â”€â”€â–¶ åŸºäºæŠ¥å‘Šæ‰§è¡Œ (å¿«é€Ÿæ‰§è¡Œ)
         â”‚                                      â”‚
         â–¼                                      â–¼
    data/analysis.json                   æ— éœ€å†æ¬¡æŸ¥è¯¢
```

**ä¼˜ç‚¹ï¼š**
- åˆ†æé˜¶æ®µå¯ç‹¬ç«‹è¿è¡Œï¼Œç”Ÿæˆå®Œæ•´æŠ¥å‘Šä¾›å®¡æŸ¥
- æ‰§è¡Œé˜¶æ®µåŸºäºæŠ¥å‘Šï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢ Notion/Mail.app
- æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼šæŠ¥å‘Šä¿å­˜åå¯éšæ—¶æ¢å¤æ‰§è¡Œ

## æ ¸å¿ƒç»„ä»¶

### InitialSync ç±»

ä¸»è¦å±æ€§ï¼š
- `sync_store`: SyncStore å®ä¾‹ï¼Œç®¡ç†æœ¬åœ°é‚®ä»¶å…ƒæ•°æ®ç¼“å­˜
- `arm`: AppleScriptArm å®ä¾‹ï¼Œä¸ Mail.app äº¤äº’
- `notion_sync`: NotionSync å®ä¾‹ï¼Œä¸ Notion API äº¤äº’
- `report`: AnalysisReport å®ä¾‹ï¼Œå­˜å‚¨åˆ†æç»“æœ

### AnalysisReport æ•°æ®ç»“æ„

```python
{
    "created_at": "2026-01-26T10:00:00",
    "comparison": {
        "matched": [...],              # å®Œå…¨åŒ¹é…ï¼ˆå·²åŒæ­¥ï¼‰
        "property_mismatch": [...],    # date/thread_id ä¸åŒ
        "critical_mismatch": [...],    # subject/sender ä¸åŒï¼ˆéœ€é‡å»ºï¼‰
        "store_only": [...],           # ä»…åœ¨ SyncStoreï¼ˆå¾…åŒæ­¥ï¼‰
        "store_only_before_date": [...], # æ—©äº sync_start_dateï¼ˆä»…ç¼“å­˜ï¼‰
        "notion_only": [...],          # ä»…åœ¨ Notionï¼ˆä¸å¤„ç†ï¼‰
    },
    "parent_analysis": {
        "total": 1234,                 # æ€»é‚®ä»¶æ•°
        "threads": {                   # æŒ‰ thread_id åˆ†ç»„çš„çº¿ç¨‹åˆ†æ
            "thread_id_1": {
                "thread_id": "thread_id_1",
                "latest_page_id": "xxx",           # æœ€æ–°é‚®ä»¶çš„ page_id
                "latest_message_id": "xxx",
                "latest_subject": "Re: ...",
                "latest_date": "2026-01-26T10:00:00+08:00",
                "latest_current_parent": null,     # æœ€æ–°é‚®ä»¶å½“å‰çš„ Parentï¼ˆåº”ä¸ºç©ºï¼‰
                "other_emails": [                  # åŒçº¿ç¨‹å…¶ä»–é‚®ä»¶
                    {
                        "page_id": "yyy",
                        "message_id": "yyy",
                        "current_parent": "zzz",   # å½“å‰ Parentï¼ˆåº”æŒ‡å‘æœ€æ–°ï¼‰
                        "need_update": true        # æ˜¯å¦éœ€è¦æ›´æ–°
                    }
                ],
                "need_update_latest": false,       # æœ€æ–°é‚®ä»¶æ˜¯å¦éœ€è¦æ¸…ç©º Parent
                "sub_items_to_set": ["yyy", ...]   # éœ€è¦è®¾ç½®ä¸º Sub-item çš„ page_id
            }
        },
        "summary": {
            "total_threads": 500,          # æ€»çº¿ç¨‹æ•°
            "single_email_threads": 300,   # åªæœ‰ä¸€å°é‚®ä»¶çš„çº¿ç¨‹
            "multi_email_threads": 200,    # å¤šå°é‚®ä»¶çš„çº¿ç¨‹
            "correct": 1000,               # å…³ç³»æ­£ç¡®çš„é‚®ä»¶æ•°
            "need_update": 234             # éœ€è¦æ›´æ–°çš„é‚®ä»¶æ•°
        }
    },
    "stats": {...}
}
```

## ä½¿ç”¨æŒ‡å—

### ç¯å¢ƒå‡†å¤‡

```bash
# 1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# 2. ç¡®ä¿é…ç½®æ­£ç¡®
# .env æ–‡ä»¶ä¸­è®¾ç½®ï¼š
#   - NOTION_TOKEN
#   - NOTION_EMAIL_DB_ID
#   - MAIL_ACCOUNT_NAME
#   - SYNC_START_DATE (å¯é€‰ï¼Œæ ¼å¼: YYYY-MM-DD)
```

### æ¨èå·¥ä½œæµç¨‹

#### Step 1: ç¼“å­˜é¢„çƒ­

è·å–å†å²é‚®ä»¶å…ƒæ•°æ®åˆ° SyncStoreï¼š

```bash
# è·å–æ”¶ä»¶ç®±æœ€æ–° 3000 å° + å‘ä»¶ç®±æœ€æ–° 500 å°
python scripts/initial_sync.py --action fetch-cache \
    --inbox-count 3000 \
    --sent-count 500
```

**è¯´æ˜ï¼š**
- é‚®ä»¶å…ƒæ•°æ®å­˜å…¥ `data/sync_store.db`
- åŒ…å« message_idã€thread_idã€subjectã€senderã€date ç­‰
- ç”¨äºåç»­ Parent Item æŸ¥æ‰¾å’Œå»é‡

#### Step 2: åˆ†æå¯¹æ¯”

åˆ†æ SyncStore ä¸ Notion çš„å·®å¼‚ï¼š

```bash
# åˆ†æå¹¶ä¿å­˜æŠ¥å‘Š
python scripts/initial_sync.py --action analyze \
    --output data/analysis.json \
    --skip-fetch  # è·³è¿‡è·å–ï¼ˆä½¿ç”¨å·²æœ‰ç¼“å­˜ï¼‰
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                        åˆ†æç»“æœ                                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ã€SyncStore vs Notion å¯¹æ¯”ã€‘                                    â”‚
  â”‚   âœ… å®Œå…¨åŒ¹é…ï¼ˆå·²åŒæ­¥ï¼‰:              1200 å°                â”‚
  â”‚   âš ï¸  å±æ€§ä¸åŒï¼ˆdate/thread_idï¼‰:       50 å°                â”‚
  â”‚   âŒ å…³é”®ä¿¡æ¯ä¸åŒï¼ˆéœ€é‡æ–°åŒæ­¥ï¼‰:         5 å°                â”‚
  â”‚   ğŸ“¤ å¾…åŒæ­¥ï¼ˆä»…åœ¨ SyncStoreï¼‰:         300 å°                â”‚
  â”‚   ğŸ“… æ—©äºåŒæ­¥æ—¥æœŸï¼ˆä»…ç¼“å­˜ï¼‰:          2000 å°                â”‚
  â”‚   â“ ä»…åœ¨ Notion:                      10 å°                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ã€Parent Item çŠ¶æ€ã€‘æ–°æ¶æ„ï¼šæœ€æ–°é‚®ä»¶ä¸ºæ¯èŠ‚ç‚¹                    â”‚
  â”‚   æ€»é‚®ä»¶æ•°: 1205 å°                                        â”‚
  â”‚   æ€»çº¿ç¨‹æ•°:  500 ä¸ª                                        â”‚
  â”‚     - å•é‚®ä»¶çº¿ç¨‹: 300 ä¸ª                                â”‚
  â”‚     - å¤šé‚®ä»¶çº¿ç¨‹: 200 ä¸ª                                â”‚
  â”‚   å…³ç³»çŠ¶æ€:                                                     â”‚
  â”‚     âœ… å·²æ­£ç¡®: 1000 å°                                        â”‚
  â”‚     âš ï¸  éœ€æ›´æ–°:  205 å°                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Step 3: æ‰§è¡Œä¿®å¤å’ŒåŒæ­¥

åŸºäºåˆ†ææŠ¥å‘Šæ‰§è¡Œæ“ä½œï¼š

```bash
# ä¿®å¤å±æ€§ï¼ˆdate/thread_idï¼‰
python scripts/initial_sync.py --action fix-properties \
    --input data/analysis.json --yes

# é‡æ–°åŒæ­¥å…³é”®ä¿¡æ¯ä¸åŒçš„é‚®ä»¶
python scripts/initial_sync.py --action fix-critical \
    --input data/analysis.json --yes

# åŒæ­¥æ–°é‚®ä»¶ï¼ˆå¯é™åˆ¶æ•°é‡ï¼‰
python scripts/initial_sync.py --action sync-new \
    --input data/analysis.json --limit 100 --yes

# æ›´æ–°æ‰€æœ‰ Parent Itemï¼ˆæ–°æ¶æ„ï¼šæœ€æ–°é‚®ä»¶ä¸ºæ¯èŠ‚ç‚¹ï¼‰
python scripts/initial_sync.py --action update-all-parents \
    --input data/analysis.json --yes
```

æˆ–è€…ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰æ“ä½œï¼š

```bash
python scripts/initial_sync.py --action all \
    --input data/analysis.json --yes
```

### å¯ç”¨çš„ Actions

| Action | è¯´æ˜ | ä¾èµ–åˆ†ææŠ¥å‘Š |
|--------|------|-------------|
| `fetch-cache` | é¢„çƒ­ç¼“å­˜ï¼ˆè·å–é‚®ä»¶åˆ° SyncStoreï¼‰ | âŒ |
| `analyze` | åˆ†æå¯¹æ¯” SyncStore vs Notion | âŒ |
| `fix-properties` | ä¿®å¤ date/thread_id å±æ€§ | âœ… |
| `fix-critical` | é‡æ–°åŒæ­¥ subject/sender ä¸åŒçš„é‚®ä»¶ | âœ… |
| `update-all-parents` | éå†éªŒè¯å¹¶ä¿®å¤æ‰€æœ‰ Parent Item | âœ… (å¯é€‰) |
| `sync-new` | åŒæ­¥æ–°é‚®ä»¶ | âœ… |
| `all` | æ‰§è¡Œæ‰€æœ‰ä¿®å¤å’ŒåŒæ­¥ | âœ… (è‡ªåŠ¨åˆ†æ) |

### å‘½ä»¤è¡Œå‚æ•°

```
--action, -a      æŒ‡å®šæ‰§è¡Œçš„æ“ä½œ
--yes, -y         è·³è¿‡ç¡®è®¤æ­¥éª¤
--limit, -l       é™åˆ¶åŒæ­¥æ•°é‡
--output, -o      ä¿å­˜åˆ†ææŠ¥å‘Šåˆ° JSON æ–‡ä»¶
--input, -i       ä» JSON æ–‡ä»¶åŠ è½½åˆ†ææŠ¥å‘Š
--skip-fetch      è·³è¿‡ä» Mail.app è·å–é‚®ä»¶
--inbox-count     æ”¶ä»¶ç®±è·å–æ•°é‡é™åˆ¶ (0=ä¸é™åˆ¶)
--sent-count      å‘ä»¶ç®±è·å–æ•°é‡é™åˆ¶ (0=ä¸é™åˆ¶)
```

## Parent Item å…³è”é€»è¾‘ï¼ˆæ–°æ¶æ„ï¼‰

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

**æ–°æ¶æ„ï¼šæœ€æ–°é‚®ä»¶ä¸ºæ¯èŠ‚ç‚¹**

ä¸ä¼ ç»Ÿçš„"çº¿ç¨‹å¤´ï¼ˆæœ€æ—©é‚®ä»¶ï¼‰ä¸ºæ¯èŠ‚ç‚¹"ä¸åŒï¼Œæ–°æ¶æ„é‡‡ç”¨ï¼š
- æ¯ä¸ªçº¿ç¨‹ä¸­**æœ€æ–°çš„é‚®ä»¶**ä½œä¸ºæ¯èŠ‚ç‚¹
- é€šè¿‡è®¾ç½®æ¯èŠ‚ç‚¹çš„ **Sub-item** å±æ€§ï¼ŒNotion ä¼šè‡ªåŠ¨æ›´æ–°æ‰€æœ‰å­é‚®ä»¶çš„ **Parent Item**

**ä¼˜ç‚¹ï¼š**
- æ‰“å¼€æœ€æ–°é‚®ä»¶æ—¶å¯ä»¥çœ‹åˆ°æ•´ä¸ªçº¿ç¨‹çš„å†å²
- åˆ©ç”¨ Notion åŒå‘å…³ç³»è‡ªåŠ¨ç»´æŠ¤ï¼Œåªéœ€ä¸€æ¬¡ API è°ƒç”¨
- æ–°é‚®ä»¶åˆ°è¾¾æ—¶è‡ªç„¶æˆä¸ºæ–°çš„æ¯èŠ‚ç‚¹

### çº¿ç¨‹å…³ç³»æ¦‚å¿µ

- **çº¿ç¨‹å¤´ï¼ˆThread Headï¼‰**ï¼šé‚®ä»¶çº¿ç¨‹çš„èµ·å§‹é‚®ä»¶ï¼Œ`thread_id == message_id`
- **å›å¤é‚®ä»¶ï¼ˆReplyï¼‰**ï¼š`thread_id != message_id`ï¼Œå…¶ `thread_id` æŒ‡å‘çº¿ç¨‹å¤´
- **æ¯èŠ‚ç‚¹ï¼ˆParentï¼‰**ï¼šçº¿ç¨‹ä¸­æœ€æ–°çš„é‚®ä»¶ï¼Œå…¶ä»–é‚®ä»¶æ˜¯å®ƒçš„ Sub-item
- **Parent Item**ï¼šNotion ä¸­çš„å…³è”å±æ€§ï¼Œè‡ªåŠ¨æŒ‡å‘æ¯èŠ‚ç‚¹

### åˆ†ç±»å¤„ç†é€»è¾‘

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   æŒ‰ thread_id åˆ†ç»„      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  å•é‚®ä»¶çº¿ç¨‹          â”‚   â”‚  å¤šé‚®ä»¶çº¿ç¨‹        â”‚
         â”‚  (ç‹¬ç«‹é‚®ä»¶)          â”‚   â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                         â”‚
                    â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ä¸åº”æœ‰ Parent     â”‚      â”‚  æŒ‰æ—¥æœŸæ’åº         â”‚
         â”‚ å¦‚æœæœ‰åˆ™éœ€æ¸…ç©º    â”‚      â”‚  ç¡®å®šæœ€æ–°é‚®ä»¶       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        â”‚                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æœ€æ–°é‚®ä»¶           â”‚  â”‚  å…¶ä»–é‚®ä»¶          â”‚  â”‚  éœ€è¦æ›´æ–°ï¼Ÿ            â”‚
         â”‚  åº”æ—  Parent Item   â”‚  â”‚  Parent åº”æŒ‡å‘æœ€æ–° â”‚  â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚                        â”‚
                    â–¼                        â–¼                        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æœ‰ Parent?       â”‚      â”‚ Parent æ­£ç¡®?    â”‚      â”‚ è®¾ç½® Sub-item   â”‚
         â”‚ â†’ need_update    â”‚      â”‚ â†’ correct       â”‚      â”‚ è‡ªåŠ¨æ›´æ–° Parent â”‚
         â”‚    _latest       â”‚      â”‚ æˆ– need_update  â”‚      â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ›´æ–°æœºåˆ¶

`update-all-parents` æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **æŒ‰ thread_id åˆ†ç»„** æ‰€æœ‰ Notion é‚®ä»¶
2. **æŒ‰æ—¥æœŸæ’åº** æ‰¾åˆ°æ¯ä¸ªçº¿ç¨‹çš„æœ€æ–°é‚®ä»¶
3. **è®¾ç½® Sub-item**ï¼šå°†æœ€æ–°é‚®ä»¶çš„ Sub-item è®¾ç½®ä¸ºåŒçº¿ç¨‹æ‰€æœ‰å…¶ä»–é‚®ä»¶
4. **Notion è‡ªåŠ¨å¤„ç†**ï¼šæ‰€æœ‰è¢«è®¾ç½®ä¸º Sub-item çš„é‚®ä»¶ï¼Œå…¶ Parent Item è‡ªåŠ¨æŒ‡å‘æœ€æ–°é‚®ä»¶

```python
# æ ¸å¿ƒé€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰
for thread_id, emails in threads.items():
    # æŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°åœ¨å‰
    sorted_emails = sort_by_date(emails, desc=True)
    latest = sorted_emails[0]
    others = sorted_emails[1:]

    # è®¾ç½®æœ€æ–°é‚®ä»¶çš„ Sub-itemï¼ˆä¸€æ¬¡ API è°ƒç”¨ï¼‰
    await notion.update_page(
        latest.page_id,
        properties={"Sub-item": {"relation": [{"id": e.page_id} for e in others]}}
    )
    # Notion è‡ªåŠ¨æ›´æ–°æ‰€æœ‰ others çš„ Parent Item æŒ‡å‘ latest
```

### æ‰§è¡Œä¼˜åŒ–

| åˆ†ç±» | æ“ä½œ | éœ€è¦ Mail.app | éœ€è¦æŸ¥ Notion |
|------|------|--------------|---------------|
| æœ€æ–°é‚®ä»¶æœ‰é”™è¯¯ Parent | æ¸…ç©º Parent | âŒ | âŒ |
| å…¶ä»–é‚®ä»¶ Parent ä¸æ­£ç¡® | è®¾ç½® Sub-item | âŒ | âŒ |
| å•é‚®ä»¶çº¿ç¨‹æœ‰ Parent | æ¸…ç©º Parent | âŒ | âŒ |

æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œæ— éœ€é¢å¤–æŸ¥è¯¢ã€‚

## å¼‚å¸¸åˆ†ç±»è¯´æ˜

### comparison åˆ†ç±»

| åˆ†ç±» | å«ä¹‰ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `matched` | å®Œå…¨åŒ¹é… | è‡ªåŠ¨æ ‡è®°ä¸º synced |
| `property_mismatch` | date/thread_id ä¸åŒ | `fix-properties` æ›´æ–°å±æ€§ |
| `critical_mismatch` | subject/sender ä¸åŒ | `fix-critical` åˆ é™¤é‡å»º |
| `store_only` | ä»…åœ¨ SyncStore | `sync-new` åŒæ­¥åˆ° Notion |
| `store_only_before_date` | æ—©äº sync_start_date | ä»…ç¼“å­˜ï¼Œä¸åŒæ­¥ |
| `notion_only` | ä»…åœ¨ Notion | ä¸å¤„ç†ï¼ˆå¯èƒ½å·²å¬å›ï¼‰ |

### parent_analysis.summary ç»Ÿè®¡

| å­—æ®µ | å«ä¹‰ |
|------|------|
| `total_threads` | æ€»çº¿ç¨‹æ•° |
| `single_email_threads` | åªæœ‰ä¸€å°é‚®ä»¶çš„çº¿ç¨‹ï¼ˆç‹¬ç«‹é‚®ä»¶ï¼‰ |
| `multi_email_threads` | å¤šå°é‚®ä»¶çš„çº¿ç¨‹ï¼ˆæœ‰å›å¤å…³ç³»ï¼‰ |
| `correct` | å…³ç³»æ­£ç¡®çš„é‚®ä»¶æ•° |
| `need_update` | éœ€è¦æ›´æ–°çš„é‚®ä»¶æ•° |

## é…ç½®é¡¹

åœ¨ `.env` ä¸­é…ç½®ï¼š

```bash
# Notion é…ç½®
NOTION_TOKEN=secret_xxx
NOTION_EMAIL_DB_ID=xxx

# Mail.app é…ç½®
MAIL_ACCOUNT_NAME=Exchange
MAIL_INBOX_NAME=æ”¶ä»¶ç®±

# åŒæ­¥é…ç½®
SYNC_MODE=hybrid
SYNC_START_DATE=2026-01-01  # åªåŒæ­¥æ­¤æ—¥æœŸä¹‹åçš„é‚®ä»¶åˆ° Notion
SYNC_STORE_DB_PATH=data/sync_store.db

# æ‰¹é‡è·å–é…ç½®
INIT_BATCH_SIZE=50  # æ¯æ‰¹è·å–é‚®ä»¶æ•°é‡
```

## æœ€ä½³å®è·µ

### é¦–æ¬¡åŒæ­¥

```bash
# 1. é¢„çƒ­ç¼“å­˜ï¼ˆæ ¹æ®éœ€è¦è°ƒæ•´æ•°é‡ï¼‰
python scripts/initial_sync.py --action fetch-cache \
    --inbox-count 3000 --sent-count 500

# 2. åˆ†æå¯¹æ¯”
python scripts/initial_sync.py --action analyze \
    --output data/analysis.json --skip-fetch

# 3. å®¡æŸ¥æŠ¥å‘Šï¼Œç¡®è®¤æ— è¯¯åæ‰§è¡Œ
python scripts/initial_sync.py --action all \
    --input data/analysis.json --yes
```

### æ—¥å¸¸ç»´æŠ¤

```bash
# å®šæœŸæ£€æŸ¥å’Œä¿®å¤ Parent Item
python scripts/initial_sync.py --action update-all-parents --yes

# å¢é‡åŒæ­¥æ–°é‚®ä»¶
python scripts/initial_sync.py --action sync-new --limit 50 --yes
```

### æ•…éšœæ’æŸ¥

```bash
# åªåˆ†æä¸æ‰§è¡Œ
python scripts/initial_sync.py --action analyze --skip-fetch

# æŸ¥çœ‹ SyncStore çŠ¶æ€
sqlite3 data/sync_store.db "SELECT sync_status, COUNT(*) FROM email_metadata GROUP BY sync_status"

# æŸ¥çœ‹å¤±è´¥çš„é‚®ä»¶
sqlite3 data/sync_store.db "SELECT message_id, error_message FROM email_metadata WHERE sync_status='failed' LIMIT 10"
```

## å®æ—¶åŒæ­¥ä¸­çš„çº¿ç¨‹å…³ç³»

å®æ—¶åŒæ­¥ï¼ˆ`new_watcher.py`ï¼‰ä¹Ÿé‡‡ç”¨ç›¸åŒçš„"æœ€æ–°é‚®ä»¶ä¸ºæ¯èŠ‚ç‚¹"é€»è¾‘ï¼š

```
æ–°é‚®ä»¶åˆ°è¾¾æ—¶:
  1. åŒæ­¥æ–°é‚®ä»¶åˆ° Notion
  2. æŸ¥æ‰¾åŒ thread_id çš„æ‰€æœ‰å·²æœ‰é‚®ä»¶ï¼ˆæŒ‰æ—¥æœŸæ’åºï¼‰
  3. åˆ¤æ–­æ–°é‚®ä»¶æ˜¯å¦æ˜¯æœ€æ–°çš„ï¼š
     - æ˜¯æœ€æ–° â†’ è®¾ç½® Sub-item åŒ…å«æ‰€æœ‰æ—§é‚®ä»¶
     - ä¸æ˜¯æœ€æ–° â†’ è®¾ç½® Parent Item æŒ‡å‘æœ€æ–°é‚®ä»¶
```

è¿™ç¡®ä¿äº†æ— è®ºæ˜¯åˆå§‹åŒ–åŒæ­¥è¿˜æ˜¯å®æ—¶åŒæ­¥ï¼Œçº¿ç¨‹å…³ç³»éƒ½ä¿æŒä¸€è‡´ã€‚

## ç›¸å…³æ–‡ä»¶

- `scripts/initial_sync.py` - ä¸»è„šæœ¬
- `src/mail/sync_store.py` - SyncStore å®ç°
- `src/mail/applescript_arm.py` - AppleScript äº¤äº’
- `src/notion/sync.py` - Notion åŒæ­¥é€»è¾‘ï¼ˆåŒ…å« `_handle_thread_relations`ï¼‰
- `src/mail/new_watcher.py` - å®æ—¶åŒæ­¥ç›‘å¬å™¨
- `data/sync_store.db` - æœ¬åœ°ç¼“å­˜æ•°æ®åº“
- `data/analysis.json` - åˆ†ææŠ¥å‘Šï¼ˆç”Ÿæˆï¼‰
