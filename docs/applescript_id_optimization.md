# AppleScript å†…éƒ¨ ID ä¼˜åŒ–æ–¹æ¡ˆ

ç”Ÿæˆæ—¶é—´: 2026-01-28
çŠ¶æ€: ğŸ“‹ **å¾…å®ç°**

## 1. éœ€æ±‚èƒŒæ™¯

### 1.1 é—®é¢˜ç°è±¡

åœ¨å¤§é‚®ç®±ç¯å¢ƒï¼ˆ6-7 ä¸‡å°é‚®ä»¶ï¼‰ä¸‹è¿è¡Œ `test_mail_reader.py`ï¼š
- âœ… è·å–æœ€æ–° 5 å°é‚®ä»¶å…ƒæ•°æ®ï¼šæ­£å¸¸ï¼ˆ~2 ç§’ï¼‰
- âŒ è·å–ç¬¬ä¸€å°é‚®ä»¶æ­£æ–‡å†…å®¹ï¼š**å¡æ­»è¶…æ—¶**ï¼ˆ>100 ç§’ï¼‰
- âŒ Mail.app åŒæ—¶å¡æ­»ï¼Œéœ€è¦å¼ºåˆ¶é€€å‡º

å°é‚®ç®±ç¯å¢ƒï¼ˆ1 ä¸‡å°é‚®ä»¶ï¼‰ä¸‹è¿è¡Œæ­£å¸¸ã€‚

### 1.2 é—®é¢˜æ ¹å› åˆ†æ

å½“å‰æ¶æ„ä½¿ç”¨ AppleScript `whose message id is "<å­—ç¬¦ä¸²>"` æŸ¥è¯¢é‚®ä»¶ï¼š

```applescript
-- å½“å‰æ–¹å¼ï¼ˆæ…¢ï¼‰
set theMessage to first message whose message id is "MWHPR05MB3390E13395C116EF4B825C38C091A@..."
```

**AppleScript çš„ `whose` å­å¥é—®é¢˜ï¼š**
- `whose` æ˜¯ **çº¿æ€§æœç´¢** (O(n))ï¼Œéœ€éå†æ‰€æœ‰é‚®ä»¶
- å­—ç¬¦ä¸²æ¯”è¾ƒï¼ˆ`message id`ï¼‰æ¯”æ•´æ•°æ¯”è¾ƒæ›´è€—æ—¶
- é‚®ç®±æœ‰å­æ–‡ä»¶å¤¹æ—¶ï¼Œå¯èƒ½è§¦å‘æ›´å¤§èŒƒå›´çš„æ‰«æ
- å¤§æ•°æ®é‡ä¸‹å¯¼è‡´ Mail.app ä¸»çº¿ç¨‹é˜»å¡

### 1.3 æ€§èƒ½æµ‹è¯•æ•°æ®

| æŸ¥è¯¢æ–¹å¼ | è€—æ—¶ | è¯´æ˜ |
|---------|------|------|
| `whose message id is "<å­—ç¬¦ä¸²>"` | **101.16 ç§’** | å½“å‰æ–¹å¼ï¼Œä¸å¯æ¥å— |
| `whose id is <æ•´æ•°>` | **0.80 ç§’** | æ–°æ–¹å¼ï¼Œæå‡ **127 å€** |

æµ‹è¯•ç¯å¢ƒï¼š1 ä¸‡å°é‚®ä»¶çš„æ”¶ä»¶ç®±ã€‚åœ¨ 6-7 ä¸‡å°é‚®ä»¶ç¯å¢ƒä¸‹å·®å¼‚æ›´å¤§ã€‚

---

## 2. å…³é”®å‘ç°

### 2.1 SQLite ROWID = AppleScript id

é€šè¿‡æµ‹è¯•éªŒè¯ï¼š

```
Mail.app SQLite æ•°æ®åº“ (Envelope Index)
â”œâ”€â”€ messages è¡¨
â”‚   â””â”€â”€ ROWID: 41457  â†â”€â”€â”€â”€â”€â”
â”‚                           â”‚ å®Œå…¨ç›¸åŒï¼
AppleScript                 â”‚
â””â”€â”€ message                 â”‚
    â””â”€â”€ id: 41457  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒè¯ç»“æœï¼š100 å°éšæœºé‚®ä»¶å¯¹æ¯”ï¼ŒåŒ¹é…ç‡ 100%**

```
æ€»æ ·æœ¬: 100
SQLite+AppleScript éƒ½æ‰¾åˆ°: 100
  - å®Œå…¨åŒ¹é…: 100
  - ä¸åŒ¹é…: 0
åŒ¹é…ç‡: 100.0%
```

### 2.2 å†å² 85% åŒ¹é…ç‡é—®é¢˜çš„åŸå› 

ä¹‹å‰å°è¯•è¿‡ SQLite + AppleScript æ˜ å°„ï¼Œä½†åªæœ‰ 85% åŒ¹é…ç‡ã€‚åŸå› æ˜¯ï¼š

| æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ |
|--------|--------|
| ç”¨ä¸»é¢˜+æ—¥æœŸ+å‘ä»¶äººå¯å‘å¼åŒ¹é… | ç”¨ ROWID = id ç›´æ¥æ˜ å°„ |
| å­—æ®µå¯èƒ½æœ‰å·®å¼‚ï¼ˆRe: å‰ç¼€ç­‰ï¼‰ | æ•´æ•° ID å®Œå…¨ä¸€è‡´ |
| ~85% åŒ¹é…ç‡ | **100% åŒ¹é…ç‡** |

---

## 3. ä¼˜åŒ–æ–¹æ¡ˆ

### 3.1 æ¶æ„å˜æ›´æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¼˜åŒ–åçš„æ•°æ®æµ (v3)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. æ£€æµ‹é˜¶æ®µ (SQLite é›·è¾¾ï¼Œ~5ms)                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ SQLite Radar â”‚ â†’ æ£€æµ‹ max_row_id å˜åŒ– â†’ æœ‰æ–°é‚®ä»¶ï¼ä¼°è®¡ N å°              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚                                                                             â”‚
â”‚  2. è·å–å…ƒæ•°æ® (AppleScriptï¼ŒæŒ‰ä½ç½®)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ fetch_emails_by_position(count=N)                                     â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ è¿”å›: message_id, id, subject, sender, date...                       â”‚  â”‚
â”‚  â”‚                  â†‘                                                    â”‚  â”‚
â”‚  â”‚                  â”‚ å…³é”®ï¼šåŒæ—¶è·å–å†…éƒ¨ idï¼ˆæ•´æ•°ï¼‰                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚  3. ç¼“å­˜æ˜ å°„                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SyncStore.email_metadata                                              â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ æ–°å¢å­—æ®µ: internal_id INTEGER                                         â”‚  â”‚
â”‚  â”‚ å­˜å‚¨: message_id â†’ internal_id æ˜ å°„                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚  4. è·å–å®Œæ•´å†…å®¹ (AppleScriptï¼ŒæŒ‰ id æŸ¥è¯¢)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ fetch_email_content_by_id(internal_id=41457)                          â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ AppleScript: whose id is 41457  â† å¿«é€Ÿï¼~1 ç§’                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 éœ€è¦ä¿®æ”¹çš„æ¨¡å—

| æ¨¡å— | æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| AppleScript Arm | `src/mail/applescript_arm.py` | 1. `fetch_emails_by_position()` é¢å¤–è¿”å› `id`<br>2. æ–°å¢ `fetch_email_content_by_id(id)` æ–¹æ³• |
| AppleScript | `src/mail/applescript.py` | 1. `get_email_details()` æ”¯æŒ `internal_id` å‚æ•°<br>2. `get_email_source()` æ”¯æŒ `internal_id` å‚æ•°<br>3. `save_attachments()` æ”¯æŒ `internal_id` å‚æ•° |
| SyncStore | `src/mail/sync_store.py` | 1. `email_metadata` è¡¨æ–°å¢ `internal_id` å­—æ®µ<br>2. æ–°å¢ `get_internal_id(message_id)` æ–¹æ³•<br>3. æ–°å¢ `save_internal_id_mapping()` æ–¹æ³• |
| EmailReader | `src/mail/reader.py` | 1. `get_email_details()` ä¼˜å…ˆä½¿ç”¨ `internal_id`<br>2. æ–°å¢ `get_email_details_by_id(id)` æ–¹æ³• |
| NewWatcher | `src/mail/new_watcher.py` | 1. ä¿å­˜é‚®ä»¶æ—¶åŒæ—¶ä¿å­˜ `internal_id`<br>2. è·å–å†…å®¹æ—¶ä¼˜å…ˆä½¿ç”¨ `internal_id` |

---

## 4. å®ç°ç»†èŠ‚

### 4.1 SyncStore æ•°æ®åº“è¿ç§»

#### 4.1.1 Schema å˜æ›´

```sql
-- æ–°å¢ internal_id å­—æ®µ
ALTER TABLE email_metadata ADD COLUMN internal_id INTEGER;

-- åˆ›å»ºç´¢å¼•ï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰
CREATE INDEX idx_email_internal_id ON email_metadata(internal_id);
```

#### 4.1.2 ç°æœ‰æ•°æ®è¿ç§»

ç°æœ‰ 3711 å°é‚®ä»¶ï¼ˆ2361 pending, 1350 syncedï¼‰éœ€è¦å›å¡« `internal_id`ï¼š

**æ–¹æ¡ˆ Aï¼šæ‡’åŠ è½½ï¼ˆæ¨èï¼‰**
- ä¸ä¸»åŠ¨è¿ç§»å†å²æ•°æ®
- å½“éœ€è¦è·å–é‚®ä»¶å†…å®¹æ—¶ï¼Œå¦‚æœ `internal_id` ä¸ºç©ºï¼Œå›é€€åˆ°æ—§æ–¹æ³•ï¼ˆ`whose message id is`ï¼‰
- æ–°é‚®ä»¶è‡ªåŠ¨ä¿å­˜ `internal_id`
- ä¼˜ç‚¹ï¼šé›¶åœæœºï¼Œæ¸è¿›è¿ç§»
- ç¼ºç‚¹ï¼šæ—§é‚®ä»¶é¦–æ¬¡è®¿é—®ä»ç„¶æ…¢

**æ–¹æ¡ˆ Bï¼šæ‰¹é‡è¿ç§»**
- è¿è¡Œè¿ç§»è„šæœ¬ï¼Œä» SQLite æŸ¥è¯¢æ‰€æœ‰é‚®ä»¶çš„ ROWID
- æ‰¹é‡æ›´æ–° SyncStore
- ä¼˜ç‚¹ï¼šä¸€æ¬¡æ€§å®Œæˆ
- ç¼ºç‚¹ï¼šéœ€è¦åœæœºï¼Œä¸” SQLite ä¸­å¯èƒ½æ‰¾ä¸åˆ°å·²åˆ é™¤çš„æ—§é‚®ä»¶

**æ¨èï¼šæ–¹æ¡ˆ Aï¼ˆæ‡’åŠ è½½ï¼‰+ å¯é€‰çš„åå°è¿ç§»**

#### 4.1.3 è¿ç§»è„šæœ¬ï¼ˆå¯é€‰ï¼‰

```python
# scripts/migrate_internal_ids.py
"""
æ‰¹é‡è¿ç§» internal_id

ä» Mail.app SQLite æ•°æ®åº“æŸ¥è¯¢ ROWIDï¼Œæ›´æ–°åˆ° SyncStoreã€‚
ä»…è¿ç§»èƒ½åœ¨ SQLite ä¸­æ‰¾åˆ°çš„é‚®ä»¶ã€‚
"""

def migrate():
    # 1. è·å–æ‰€æœ‰ SyncStore ä¸­çš„ message_id
    # 2. ä» SQLite æŸ¥è¯¢å¯¹åº”çš„ ROWID
    # 3. æ‰¹é‡æ›´æ–° SyncStore
    pass
```

### 4.2 AppleScriptArm ä¿®æ”¹

#### 4.2.1 fetch_emails_by_position è¿”å› id

```python
# å½“å‰è¿”å›
{
    'message_id': '<xxx@example.com>',
    'subject': 'Test',
    'sender': 'a@b.com',
    ...
}

# ä¿®æ”¹åè¿”å›
{
    'message_id': '<xxx@example.com>',
    'id': 41457,  # æ–°å¢ï¼šå†…éƒ¨ id
    'subject': 'Test',
    'sender': 'a@b.com',
    ...
}
```

AppleScript ä¿®æ”¹ï¼š
```applescript
-- åœ¨è·å–é‚®ä»¶ä¿¡æ¯æ—¶ï¼ŒåŒæ—¶è·å– id
set msgMessageId to message id of m
set msgInternalId to id of m  -- æ–°å¢
```

#### 4.2.2 æ–°å¢ fetch_email_content_by_id

```python
def fetch_email_content_by_id(self, internal_id: int, mailbox: str = None) -> Optional[Dict[str, Any]]:
    """
    é€šè¿‡å†…éƒ¨ idï¼ˆæ•´æ•°ï¼‰è·å–é‚®ä»¶å®Œæ•´å†…å®¹

    æ€§èƒ½ï¼š~1 ç§’ï¼ˆvs æ—§æ–¹æ³• ~100 ç§’ï¼‰

    Args:
        internal_id: é‚®ä»¶å†…éƒ¨ idï¼ˆæ•´æ•°ï¼Œç­‰äº SQLite ROWIDï¼‰
        mailbox: é‚®ç®±åç§°ï¼ˆå¯é€‰ï¼Œä¸æŒ‡å®šåˆ™æœç´¢æ‰€æœ‰é‚®ç®±ï¼‰

    Returns:
        Dict åŒ…å« message_id, subject, sender, date, content, source, is_read, is_flagged
    """
```

AppleScript æ ¸å¿ƒé€»è¾‘ï¼š
```applescript
tell application "Mail"
    tell account "Exchange"
        -- å¦‚æœæŒ‡å®šäº†é‚®ç®±ï¼Œç›´æ¥åœ¨è¯¥é‚®ç®±æŸ¥æ‰¾
        if mailbox is specified then
            tell mailbox "æ”¶ä»¶ç®±"
                set theMessage to first message whose id is 41457
            end tell
        else
            -- å¦åˆ™éå†æ‰€æœ‰é‚®ç®±æŸ¥æ‰¾
            repeat with mbox in mailboxes
                try
                    set theMessage to first message of mbox whose id is 41457
                    exit repeat
                end try
            end repeat
        end if

        -- è·å–é‚®ä»¶å†…å®¹
        return subject of theMessage & ...
    end tell
end tell
```

### 4.3 NewWatcher ä¿®æ”¹

```python
async def _sync_single_email(self, email_meta: Dict[str, Any], mailbox: str):
    message_id = email_meta.get('message_id')
    internal_id = email_meta.get('id')  # æ–°å¢ï¼šè·å–å†…éƒ¨ id

    # 1. ä¿å­˜åˆ° SyncStoreï¼ˆåŒ…å« internal_idï¼‰
    self.sync_store.save_email({
        'message_id': message_id,
        'internal_id': internal_id,  # æ–°å¢
        ...
    })

    # 2. è·å–å®Œæ•´é‚®ä»¶å†…å®¹ï¼ˆä¼˜å…ˆä½¿ç”¨ internal_idï¼‰
    if internal_id:
        full_email = self.arm.fetch_email_content_by_id(internal_id, mailbox)
    else:
        # å›é€€åˆ°æ—§æ–¹æ³•
        full_email = self.arm.fetch_email_by_message_id(message_id, mailbox)
```

### 4.4 å…¼å®¹æ€§å¤„ç†

ä¸ºç¡®ä¿å¹³æ»‘å‡çº§ï¼Œæ‰€æœ‰ä½¿ç”¨ `internal_id` çš„åœ°æ–¹éƒ½éœ€è¦å›é€€é€»è¾‘ï¼š

```python
def get_email_content(self, message_id: str, internal_id: int = None, mailbox: str = None):
    """è·å–é‚®ä»¶å†…å®¹ï¼Œä¼˜å…ˆä½¿ç”¨ internal_id"""

    if internal_id:
        # å¿«é€Ÿè·¯å¾„ï¼šä½¿ç”¨ internal_id
        result = self._fetch_by_internal_id(internal_id, mailbox)
        if result:
            return result
        # å¦‚æœ internal_id æŸ¥æ‰¾å¤±è´¥ï¼ˆé‚®ä»¶è¢«ç§»åŠ¨/åˆ é™¤ï¼‰ï¼Œè®°å½•æ—¥å¿—
        logger.warning(f"internal_id {internal_id} not found, falling back to message_id")

    # å›é€€è·¯å¾„ï¼šä½¿ç”¨ message_idï¼ˆæ…¢ï¼‰
    return self._fetch_by_message_id(message_id, mailbox)
```

---

## 5. æµ‹è¯•è®¡åˆ’

### 5.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•é¡¹ | æè¿° |
|--------|------|
| test_fetch_emails_with_id | éªŒè¯ `fetch_emails_by_position` è¿”å› `id` å­—æ®µ |
| test_fetch_content_by_id | éªŒè¯ `fetch_email_content_by_id` åŠŸèƒ½æ­£ç¡® |
| test_id_mapping_accuracy | éªŒè¯ SQLite ROWID = AppleScript idï¼ˆ100 å°éšæœºæŠ½æ ·ï¼‰ |
| test_fallback_to_message_id | éªŒè¯ internal_id ä¸å­˜åœ¨æ—¶å›é€€åˆ° message_id |

### 5.2 é›†æˆæµ‹è¯•

| æµ‹è¯•é¡¹ | æè¿° |
|--------|------|
| test_small_mailbox | å°é‚®ç®±ï¼ˆ1 ä¸‡å°ï¼‰å®Œæ•´åŒæ­¥æµç¨‹ |
| test_large_mailbox | å¤§é‚®ç®±ï¼ˆ6-7 ä¸‡å°ï¼‰å®Œæ•´åŒæ­¥æµç¨‹ |
| test_migration | ç°æœ‰æ•°æ®è¿ç§»ååŠŸèƒ½æ­£å¸¸ |

### 5.3 æ€§èƒ½æµ‹è¯•

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| è·å–å•å°é‚®ä»¶å†…å®¹ï¼ˆæ–°æ–¹æ³•ï¼‰ | < 3 ç§’ |
| è·å–å•å°é‚®ä»¶å†…å®¹ï¼ˆæ—§æ–¹æ³•å›é€€ï¼‰ | < 120 ç§’ï¼ˆä¸å¡æ­»ï¼‰ |
| æ‰¹é‡åŒæ­¥ 100 å°é‚®ä»¶ | < 5 åˆ†é’Ÿ |

---

## 6. å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½ï¼ˆé¢„è®¡ 1 å¤©ï¼‰

1. [ ] SyncStore æ·»åŠ  `internal_id` å­—æ®µï¼ˆå…¼å®¹æ€§è¿ç§»ï¼‰
2. [ ] AppleScriptArm ä¿®æ”¹ `fetch_emails_by_position` è¿”å› `id`
3. [ ] AppleScriptArm æ–°å¢ `fetch_email_content_by_id` æ–¹æ³•

### Phase 2: æ ¸å¿ƒé€»è¾‘ï¼ˆé¢„è®¡ 1 å¤©ï¼‰

4. [ ] MailAppScripts ä¿®æ”¹ `get_email_details` æ”¯æŒ `internal_id`
5. [ ] MailAppScripts ä¿®æ”¹ `get_email_source` æ”¯æŒ `internal_id`
6. [ ] MailAppScripts ä¿®æ”¹ `save_attachments` æ”¯æŒ `internal_id`
7. [ ] EmailReader ä¿®æ”¹ `get_email_details` ä¼˜å…ˆä½¿ç”¨ `internal_id`

### Phase 3: é›†æˆï¼ˆé¢„è®¡ 0.5 å¤©ï¼‰

8. [ ] NewWatcher ä¿®æ”¹ä¿å­˜å’Œè·å–é€»è¾‘
9. [ ] æ·»åŠ å›é€€å…¼å®¹æ€§å¤„ç†

### Phase 4: æµ‹è¯• & å‘å¸ƒï¼ˆé¢„è®¡ 0.5 å¤©ï¼‰

10. [ ] æœ¬åœ°æµ‹è¯•ï¼ˆå°é‚®ç®±ï¼‰
11. [ ] åŒäº‹æµ‹è¯•ï¼ˆå¤§é‚®ç®±ï¼‰
12. [ ] å¯é€‰ï¼šè¿è¡Œè¿ç§»è„šæœ¬å›å¡«å†å²æ•°æ®

---

## 7. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| internal_id å¯èƒ½å˜åŒ–ï¼ˆé‚®ä»¶ç§»åŠ¨/åˆ é™¤åï¼‰ | æŸ¥æ‰¾å¤±è´¥ | å›é€€åˆ° message_id æŸ¥è¯¢ |
| SQLite æ•°æ®åº“ç»“æ„å˜åŒ– | ROWID æ˜ å°„å¤±æ•ˆ | å®šæœŸéªŒè¯æ˜ å°„å‡†ç¡®æ€§ |
| è¿ç§»è„šæœ¬å½±å“æœåŠ¡ | æœåŠ¡ä¸­æ–­ | ä½¿ç”¨æ‡’åŠ è½½ï¼Œè¿ç§»è„šæœ¬å¯é€‰ |

---

## 8. é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å•å°é‚®ä»¶å†…å®¹è·å– | ~100 ç§’ | ~1-3 ç§’ | **30-100x** |
| å¤§é‚®ç®±æ”¯æŒ | âŒ å¡æ­» | âœ… æ­£å¸¸ | - |
| Mail.app ç¨³å®šæ€§ | âŒ å¡æ­» | âœ… æ­£å¸¸ | - |

---

## é™„å½• A: æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œä¼˜åŒ–åçš„æµ‹è¯•è„šæœ¬
python3 scripts/test_mail_reader.py

# éªŒè¯ ROWID-id æ˜ å°„ï¼ˆ100 å°éšæœºæŠ½æ ·ï¼‰
python3 /tmp/test_id_mapping.py

# æ£€æŸ¥ SyncStore çŠ¶æ€
sqlite3 data/sync_store.db "SELECT COUNT(*), sync_status FROM email_metadata GROUP BY sync_status;"
```

## é™„å½• B: ç›¸å…³æ–‡ä»¶

- `src/mail/applescript_arm.py` - AppleScript æœºæ¢°è‡‚
- `src/mail/applescript.py` - AppleScript è„šæœ¬å°è£…
- `src/mail/reader.py` - é‚®ä»¶è¯»å–å™¨
- `src/mail/sync_store.py` - åŒæ­¥çŠ¶æ€å­˜å‚¨
- `src/mail/new_watcher.py` - æ–°æ¶æ„ç›‘å¬å™¨
- `scripts/test_mail_reader.py` - æµ‹è¯•è„šæœ¬
